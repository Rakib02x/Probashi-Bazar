<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FreshMart тАФржП ржЖржкржирж╛рж░ ржкржЫржирзНржжрзЗрж░ ржЧрзНрж░рзЛрж╕рж╛рж░рж┐</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet" />

   

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADtV06zQSN1mgfHPGyMd9XMrcnaBDbIl8",
            authDomain: "bazar-coltrolpanel.firebaseapp.com",
            projectId: "bazar-coltrolpanel",
            storageBucket: "bazar-coltrolpanel.firebasestorage.app",
            messagingSenderId: "434325187483",
            appId: "1:434325187483:web:2bbdf219d027545798cf3e",
            measurementId: "G-JRFJTKQ2XK"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // --- Firebase ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛ ---

        window.fetchData = async (path) => {
            // Firebase Realtime Database ржерзЗржХрзЗ ржбрзЗржЯрж╛ ржЖржирж╛
            const dataRef = ref(db, path);
            const snapshot = await get(dataRef);
            if (snapshot.exists()) {
                return snapshot.val();
            } else {
                console.log(`No data available at ${path}`);
                return {};
            }
        };

        window.saveUser = async (userData, password) => {
            // user/ржЗржорзЗржЗрж▓ ржПрж░ ржнрзЗрждрж░рзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рж╛рж░ рж▓ржЬрж┐ржХ
            const emailKey = userData.email.replace(/\./g, ','); // ржЗржорзЗржЗрж▓рзЗрж░ ржбржЯ ржХржорж╛ ржжрж┐ржпрж╝рзЗ рж░рж┐ржкрзНрж▓рзЗрж╕ ржХрж░рж╛
            const userRef = ref(db, `user/${emailKey}`);
            // ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж╕рж╛ржзрж╛рж░ржгржд рж╣рзНржпрж╛рж╢ ржХрж░рзЗ рж╕рзЗржн ржХрж░рж╛ ржЙржЪрж┐ржд, ржПржЦрж╛ржирзЗ рж╕рж░рж▓ржнрж╛ржмрзЗ рж╕рзЗржн ржХрж░рж╛ рж╣рж▓рзЛ
            return set(userRef, {...userData, password: password });
        };

        window.loginUser = async (email, password) => {
            // user/ржЗржорзЗржЗрж▓ ржПрж░ ржнрзЗрждрж░рзЗ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЪрзЗржХ ржХрж░рзЗ рж▓ржЧржЗржи ржХрж░рж╛рж░ рж▓ржЬрж┐ржХ
            const emailKey = email.replace(/\./g, ',');
            const userRef = ref(db, `user/${emailKey}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                if (userData.password === password) { // ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЪрзЗржХ
                    return { success: true, user: userData };
                }
            }
            return { success: false, user: null };
        };

        window.saveOrder = async (orderData) => {
            // order ржлрзЛрж▓рзНржбрж╛рж░рзЗ rendomid рждрзИрж░рж┐ ржХрж░рзЗ ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рж╛рж░ рж▓ржЬрж┐ржХ
            const orderRef = ref(db, 'order');
            return push(orderRef, orderData); // push() рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржПржХржЯрж┐ рж░рзНржпрж╛ржирзНржбржо ржЖржЗржбрж┐ рждрзИрж░рж┐ ржХрж░рзЗ
        };
    </script>

    <header class="shopnow-header-container">
        <div class="header-bar">


            <div class="logo-tex">
                <img class="logo" src="logo.png"> </img>
            </div>

            <div class="icon-group-top">
                <div id="loginBtn" class="search-icon-top">
                    <span class="material-symbols-outlined">
                        person
                    </span>
                    <span id="loginBtnText" class="user-name-text">рж▓ржЧржЗржи</span>
                </div>

                <div class="cart-icon-container" id="cartBtn">
                    <div class="cart-icon">
                        <span class="material-symbols-outlined">
                            shopping_cart
                        </span>
                    </div>
                    <span id="cartCount" class="cart-badge">0</span>
                </div>
            </div>
        </div>

        <div class="search-bar-section">
            <input type="text" id="searchInput" class="search-input-new" placeholder="ржЕржирзБрж╕ржирзНржзрж╛ржи ржХрж░рзБржи.....">
            <button id="searchButton" class="search-button">ржЦрзБржБржЬрзБржи</button>
            <div id="suggestionsBox"></div> </div>
    </header>


    <section class="cats">
        <div class="row" id="categoryRow">
        </div>
    </section>

    <section class="hero">
        <div class="slider" id="slider">
            <div class="slides" id="slides">
                <div class="slide">
                    <div class="copy">
                        <span class="tag">ржлрзНрж░рзЗрж╢ ржбрзЗржЗрж▓рж┐</span>
                        <h2>рж╕ржкрзНрждрж╛рж╣ржЬрзБржбрж╝рзЗ рждрж╛ржЬрж╛ рж╕ржмржЬрж┐ & ржлрж▓</h2>
                        <p>рж╕рзНржерж╛ржирзАржпрж╝ ржлрж╛рж░рзНржо ржерзЗржХрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ тАФ ржХрж╛ржБржЪрж╛ржорж╛рж▓, ржнрж╛рж▓рзЛ ржжрж╛ржорзЗред</p>
                        <button class="btn" onclick="scrollToProducts()">рж╢ржк ржХрж░рзБржи</button>
                    </div>
                    <img src="https://images.unsplash.com/photo-1542838132-92c53300491e?w=1200&q=60&auto=format&fit=crop" alt="banner1">
                </div>
                <div class="slide">
                    <div class="copy">
                        <span class="tag">ржбрзЗржЗрж▓рж┐ ржбрж┐рж▓рж╕</span>
                        <h2>ржЖржЬржХрзЗрж░ ржмрж┐рж╢рзЗрж╖ ржЫрж╛ржбрж╝</h2>
                        <p>ржирж┐рждрзНржпржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржкржгрзНржпрзЗ ржмрж┐рж╢рзЗрж╖ ржЫрж╛ржбрж╝ тАФ ржоржЬрзБржж рж╕рзАржорж┐рждред</p>
                        <button class="btn" onclick="scrollToProducts()">ржбрж┐рж▓ ржжрзЗржЦрзБржи</button>
                    </div>
                    <img src="https://images.unsplash.com/photo-1498654208925-3a3f6c8f6a91?w=1200&q=60&auto=format&fit=crop" alt="banner2">
                </div>
            </div>
            <div class="controls">
                <div class="ctrl" onclick="prevSlide()">тЧА</div>
                <div class="ctrl" onclick="nextSlide()">тЦ╢</div>
            </div>
        </div>
    </section>

    <main class="container" id="productsContainer">
    </main>

    <footer>
        <div class="footer-grid">
            <div>
                <h4>FreshMart</h4>
                <p class="muted">ржЖржкржирж╛рж░ ржЖрж╢рзЗржкрж╛рж╢рзЗрж░ рждрж╛ржЬрж╛ ржмрж╛ржЬрж╛рж░ тАФ ржжрзНрж░рзБржд ржбрзЗрж▓рж┐ржнрж╛рж░рж┐, рж╕рж╣ржЬ рж░рж┐ржЯрж╛рж░рзНржи, рж╕рзЗрж░рж╛ ржХрж╛рж╕рзНржЯржорж╛рж░ рж╕рж╛рж░рзНржнрж┐рж╕ред</p>
                <div class="socials">
                    <a aria-label="facebook" href="#" style="color:#3b5998">ЁЯФ╡</a>
                    <a aria-label="instagram" href="#" style="color:#c32aa3">ЁЯУ╕</a>
                    <a aria-label="tw" href="#" style="color:#00acee">ЁЯРж</a>
                </div>
            </div>
            <div>
                <h4>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐рж╕</h4>
                <p class="muted">рж╕ржмржЬрж┐<br>ржлрж▓<br>ржжрзБржз & ржбрзЗржЗрж░рж┐<br>рж╕рзНржЯрзНржпрж╛ржкрж▓рж╕</p>
            </div>
            <div>
                <h4>рж╕рж╛ржкрзЛрж░рзНржЯ</h4>
                <p class="muted">рж╣рзЗрж▓рзНржк рж╕рзЗржирзНржЯрж╛рж░<br>рж╢рж┐ржкрж┐ржВ & рж░рж┐ржЯрж╛рж░рзНржи<br>ржХржиржЯрзНржпрж╛ржХрзНржЯ</p>
            </div>
            <div>
                <h4>ржирж┐ржЙржЬрж▓рзЗржЯрж╛рж░</h4>
                <p class="muted">ржмрж┐рж╢рзЗрж╖ ржбрж┐рж╕ржХрж╛ржЙржирзНржЯ ржкрзЗрждрзЗ рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм ржХрж░рзБржиред</p>
                <div style="margin-top:8px;display:flex;gap:8px">
                    <input placeholder="ржЗржорзЗржЗрж▓ рж▓рж┐ржЦрзБржи" style="padding:8px;border-radius:8px;border:none;flex:1">
                    <button class="btn">рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржм</button>
                </div>
            </div>
        </div>
        <p style="text-align:center;color:#94a3b8;margin-top:18px">┬й 2025 FreshMart тАв рж╕ржХрж▓ ржЕржзрж┐ржХрж╛рж░ рж╕ржВрж░ржХрзНрж╖рж┐ржд</p>
    </footer>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2 id="modalTitle">рж▓ржЧржЗржи</h2>
            <form id="loginForm" class="login-form active">
                <div class="form-group"><input type="email" id="loginEmail" placeholder="ржЗржорзЗржЗрж▓" required></div>
                <div class="form-group"><input type="password" id="loginPassword" placeholder="ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб" required></div>
                <button type="submit" class="btn">рж▓ржЧржЗржи ржХрж░рзБржи</button>
                <p class="switch-link">ржПржХрж╛ржЙржирзНржЯ ржирзЗржЗ? <span id="switchToRegister">рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ ржХрж░рзБржи</span></p>
            </form>

            <form id="registerForm" class="login-form">
                <div class="form-group"><input type="text" id="regName" placeholder="ржирж╛ржо" required></div>
                <div class="form-group"><input type="email" id="regEmail" placeholder="ржЗржорзЗржЗрж▓" required></div>
                <div class="form-group"><input type="tel" id="regNumber" placeholder="ржлрзЛржи ржирж╛ржорзНржмрж╛рж░" required></div>
                <div class="form-group"><input type="text" id="regAddress" placeholder="ржарж┐ржХрж╛ржирж╛" required></div>
                <div class="form-group"><input type="password" id="regPassword" placeholder="ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб" required></div>
                <button type="submit" class="btn">рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░</button>
                <p class="switch-link">ржПржХрж╛ржЙржирзНржЯ ржЖржЫрзЗ? <span id="switchToLogin">рж▓ржЧржЗржи ржХрж░рзБржи</span></p>
            </form>
        </div>
    </div>

    <div id="variantSheet" class="bottom-sheet">
        <div class="sheet-content">
            <button class="close-modal-btn" id="closeSheetBtn">&times;</button>
            <div class="sheet-details">
                <img id="sheetProductImage" src="https://via.placeholder.com/80" alt="Product" class="sheet-prod-img">
                <div class="details-text">
                    <h3 id="sheetProductName" style="margin:0;">ржЖрж▓рзБ</h3>
                    <p id="sheetProductPricePerUnit" class="muted" style="margin:4px 0 0;">RM рзирзж/ржХрзЗржЬрж┐</p>
                </div>
            </div>

            <h4 class="sheet-sub-title">ржнрзЗрж░рж┐ржпрж╝рзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:</h4>
            <div id="variantChoices" class="variant-choices">
            </div>

            <div class="sheet-action-bar">
                <div class="price-display">
                    ржорзЛржЯ ржжрж╛ржо: RN <span id="totalPriceDisplay">0.00</span>
                </div>
                <button id="addToCartConfirmBtn" class="btn">ржХрж┐ржирзБржи</button>
            </div>
        </div>
    </div>

    <aside id="cartSidebar" class="cart-sidebar">
        <div class="sidebar-header">
            <h3>ржЖржорж╛рж░ ржмрзНржпрж╛ржЧ (<span id="sidebarCartCount">0</span>)</h3>
            <button class="close-sidebar-btn">&times;</button>
        </div>
        <div class="cart-items" id="cartItemsList">
            <p class="empty-cart-msg">ржЖржкржирж╛рж░ ржмрзНржпрж╛ржЧ ржЦрж╛рж▓рж┐ред</p>
        </div>
        <div class="sidebar-footer">
            <div class="checkout-total">
                <p>ржорзЛржЯ ржорзВрж▓рзНржп:</p>
                <p>RM <span id="checkoutTotalAmount">0.00</span></p>
            </div>
            <button class="checkout-btn online-payment-btn"><i class="fas fa-credit-card"></i> ржЕржирж▓рж╛ржЗржи ржкрзЗржорзЗржирзНржЯ ржХрж░рзБржи</button>
            <button id="cashOnDeliveryBtn" class="checkout-btn cod-btn pulse-animation"><i class="fas fa-truck"></i> ржХрзНржпрж╛рж╢ ржЕржи ржбрзЗрж▓рж┐ржнрж╛рж░рж┐</button>
        </div>
    </aside>

    <div id="codModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2>ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рждржерзНржп</h2>
            <form id="codForm" class="cod-form">
                <div class="form-group"><input type="text" id="codName" placeholder="ржЖржкржирж╛рж░ ржирж╛ржо" required></div>
                <div class="form-group"><input type="tel" id="codNumber" placeholder="ржлрзЛржи ржирж╛ржорзНржмрж╛рж░" required></div>
                <div class="form-group"><input type="text" id="codAddress" placeholder="ржбрзЗрж▓рж┐ржнрж╛рж░рж┐рж░ ржарж┐ржХрж╛ржирж╛" required></div>

                <div class="order-summary">
                    <h4>ржЕрж░рзНржбрж╛рж░ рж╕рж╛ржорж╛рж░рж┐:</h4>
                    <p>ржорзЛржЯ ржкрзНрж░ржбрж╛ржХрзНржЯ: <span id="codTotalItems">0</span> ржЯрж┐</p>
                    <p style="font-size:1.1rem; font-weight:bold;">рж╕рж░рзНржмржорзЛржЯ ржмрж┐рж▓: RM <span id="codTotalBill">0.00</span></p>
                </div>

                <button type="submit" class="btn confirm-btn">ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо ржХрж░рзБржи</button>
            </form>
        </div>
    </div>

    <script>
        // ржЬрж╛ржнрж╛рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж▓ржЬрж┐ржХ рж╢рзБрж░рзБ
        document.addEventListener('DOMContentLoaded', () => {
            // DOM ржПрж▓рж┐ржорзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи (ржЖржкржирж╛рж░ ржХрзЛржб ржерзЗржХрзЗ ржирзЗржУржпрж╝рж╛)
            const loginModal = document.getElementById('loginModal');
            const loginBtn = document.getElementById('loginBtn');
            const closeModals = document.querySelectorAll('.close-modal-btn');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const switchToRegister = document.getElementById('switchToRegister');
            const switchToLogin = document.getElementById('switchToLogin');
            const modalTitle = document.getElementById('modalTitle');

            const variantSheet = document.getElementById('variantSheet');
            const closeSheetBtn = document.getElementById('closeSheetBtn');
            const productsContainer = document.getElementById('productsContainer');
            const variantChoices = document.getElementById('variantChoices');
            const totalPriceDisplay = document.getElementById('totalPriceDisplay');
            const addToCartConfirmBtn = document.getElementById('addToCartConfirmBtn');

            const cartSidebar = document.getElementById('cartSidebar');
            const cartBtn = document.getElementById('cartBtn');
            const closeSidebarBtn = document.querySelector('.close-sidebar-btn');
            const cartCount = document.getElementById('cartCount');
            const sidebarCartCount = document.getElementById('sidebarCartCount');
            const cartItemsList = document.getElementById('cartItemsList');
            const checkoutTotalAmount = document.getElementById('checkoutTotalAmount');

            const cashOnDeliveryBtn = document.getElementById('cashOnDeliveryBtn');
            const codModal = document.getElementById('codModal');
            const codForm = document.getElementById('codForm');
            const codTotalBill = document.getElementById('codTotalBill');
            const codTotalItems = document.getElementById('codTotalItems');

            // --- ржирждрзБржи DOM ржПрж▓рж┐ржорзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ---
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const suggestionsBox = document.getElementById('suggestionsBox');
            // ---

            let currentProduct = null;
            let selectedVariant = null;
            let cart = [];
            let loggedInUser = null;
            let allProducts = []; // рж╕ржорж╕рзНржд ржкрзНрж░рзЛржбрж╛ржХрзНржЯрзЗрж░ рждрж╛рж▓рж┐ржХрж╛

            // --- ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржПржмржВ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ рж▓рзЛржб ржХрж░рж╛ ---
            async function loadData() {
                try {
                    // Firebase ржерзЗржХрзЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржбрзЗржЯрж╛ fetchCategories() ржлрж╛ржВрж╢ржи ржжрж┐ржпрж╝рзЗ ржЖржиржмрзЗ
                    const categoryData = await window.fetchData('catagory');
                    const productData = await window.fetchData('product');

                    // рж╕ржорж╕рзНржд ржкрзНрж░рзЛржбрж╛ржХрзНржЯ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛
                    if (productData) {
                        allProducts = Object.keys(productData).map(key => ({
                            id: key,
                            ...productData[key]
                        }));
                    }
                    
                    renderCategories(categoryData);
                    renderProducts(allProducts); // рж╢рзБрж░рзБрждрзЗ рж╕ржорж╕рзНржд ржкрзНрж░рзЛржбрж╛ржХрзНржЯ рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛

                } catch (error) {
                    console.error("Firebase ржбрзЗржЯрж╛ рж▓рзЛржб ржХрж░рждрзЗ ржмрзНржпрж░рзНрже:", error);
                    // ржлрзЗржЗржХ ржбрзЗржЯрж╛ ржмрж╛ ржкрзНрж▓рзЗрж╕рж╣рзЛрж▓рзНржбрж╛рж░ ржбрзЗржЯрж╛ ржжрж┐ржпрж╝рзЗ UI рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ
                }
            }

            function renderCategories(categoryData) {
                const categoryRow = document.getElementById('categoryRow');
                categoryRow.innerHTML = '';

                if (categoryData) {
                    Object.keys(categoryData).forEach(key => {
                        const cat = categoryData[key];
                        const el = document.createElement('div'); el.className='cat';
                        // ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ID ржжрж┐ржпрж╝рзЗ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржмрзНрж▓ржХрзЗ рж╕рзНржХрзНрж░рж▓ ржХрж░рж╛рж░ ржЬржирзНржп ржбрзЗржЯрж╛ рж╕рзЗржЯ ржХрж░рж╛
                        el.dataset.catId = cat.name.replace(/\s+/g, '-');
                        el.innerHTML = `<img src="${cat.image}" alt="${cat.name}"><p>${cat.name}</p>`;
                        categoryRow.appendChild(el);
                    });
                }
            }

            function renderProducts(productsArr) {
                productsContainer.innerHTML = '';
                const groupedProducts = {};

                // ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржЕржирзБржпрж╛ржпрж╝рзА ржЧрзНрж░рзБржкрж┐ржВ
                if (productsArr.length > 0) {
                    productsArr.forEach(prod => {
                        const catName = prod['catagory name'];
                        if (!groupedProducts[catName]) {
                            groupedProducts[catName] = [];
                        }
                        groupedProducts[catName].push(prod);
                    });
                } else if (searchInput.value.trim() !== "") {
                     // рж╕рж╛рж░рзНржЪ ржХрж░рж╛рж░ ржкрж░рзЗржУ ржХрж┐ржЫрзБ ржирж╛ ржкрзЗрж▓рзЗ ржорзЗрж╕рзЗржЬ ржжрзЗржЦрж╛ржирзЛ
                    productsContainer.innerHTML = '<p style="text-align:center; padding:20px; font-size:1.2em;">ржжрзБржГржЦрж┐ржд, ржПржЗ ржирж╛ржорзЗрж░ ржХрзЛржирзЛ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред</p>';
                    return; // ржХрж┐ржЫрзБ ржирж╛ ржерж╛ржХрж▓рзЗ ржЖрж░ рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ
                }

                // рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛
                Object.keys(groupedProducts).forEach(catName => {
                    const catId = catName.replace(/\s+/g, '-');
                    // ржпржЦржи рж╕рж╛рж░рзНржЪ ржХрж░рж╛ рж╣ржмрзЗ рждржЦржи category-block ржПрж░ id ржПрж░ рж╢рзЗрж╖рзЗ '-block' ржпрзЛржЧ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ, ржпрж╛рждрзЗ scrollIntoView ржХрж╛ржЬ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
                    const blockId = searchInput.value.trim() === "" ? catId + '-block' : catId + '-search-block'; // рж╕рж╛рж░рзНржЪрзЗрж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ id
                    const block = document.createElement('section'); block.className='category-block'; block.id = blockId;
                    block.innerHTML = `<h3>${catName}</h3><div class="products"></div>`;
                    const grid = block.querySelector('.products');

                    groupedProducts[catName].forEach(prod => {
                        const card = document.createElement('div'); card.className='card';
                        // Add to Cart ржмрж╛ржЯржирзЗ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржбрзЗржЯрж╛ рж╕рзЗржЯ ржХрж░рж╛
                        card.innerHTML = `
                            <img src="${prod['product image']}" alt="${prod['products name']}">
                            <div class="name">${prod['products name']}</div>
                            <div class="price">RM ${prod['product price']} <span class="price-per">/ржкрзНрж░рждрж┐ ржХрзЗржЬрж┐</span></div>
                            <div style="margin-top:auto;">
                                <button class="btn add-to-cart-trigger"
                                    data-id="${prod.id}"
                                    data-name="${prod['products name']}"
                                    data-image="${prod['product image']}"
                                    data-price="${prod['product price']}"
                                    data-variants="${prod['product variant']}"
                                    >ржХрж┐ржирзБржи</button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    productsContainer.appendChild(block);
                });
            }

            // --- рж╕рж╛рж░рзНржЪ рж▓ржЬрж┐ржХ ---
            function performSearch(query) {
                const lowerCaseQuery = query.toLowerCase().trim();
                if (lowerCaseQuery === "") {
                    renderProducts(allProducts); // ржЦрж╛рж▓рж┐ рж╣рж▓рзЗ рж╕ржм ржжрзЗржЦрж╛ржмрзЗ
                    return;
                }

                const filteredProducts = allProducts.filter(product => 
                    product['products name'].toLowerCase().includes(lowerCaseQuery)
                );
                
                renderProducts(filteredProducts);
            }

            // рж╕рж╛ржЬрзЗрж╢ржи ржжрзЗржЦрж╛ржирзЛ
            function showSuggestions(query) {
                suggestionsBox.innerHTML = '';
                const lowerCaseQuery = query.toLowerCase().trim();

                if (lowerCaseQuery.length < 2) {
                    return; // рзи ржЕржХрзНрж╖рж░рзЗрж░ ржХржо рж╣рж▓рзЗ рж╕рж╛ржЬрзЗрж╢ржи ржжрзЗржЦрж╛ржирзЛрж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ
                }

                const matchedProducts = allProducts.filter(product => 
                    product['products name'].toLowerCase().includes(lowerCaseQuery)
                ).slice(0, 5); // ржкрзНрж░ржержо рзлржЯрж┐ рж╕рж╛ржЬрзЗрж╢ржи

                matchedProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `<img src="${product['product image']}" alt="${product['products name']}"> ${product['products name']}`;
                    
                    item.addEventListener('click', () => {
                        searchInput.value = product['products name'];
                        performSearch(product['products name']);
                        suggestionsBox.innerHTML = ''; // рж╕рж╛ржЬрзЗрж╢ржи ржмржирзНржз
                    });

                    suggestionsBox.appendChild(item);
                });
            }

            // рж╕рж╛рж░рзНржЪ ржЗржиржкрзБржЯ ржЗржнрзЗржирзНржЯ
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                showSuggestions(query);

            // **ржирждрзБржи рж╕ржВржпрзЛржЬржи:** ржЗржиржкрзБржЯ ржЦрж╛рж▓рж┐ рж╣рж▓рзЗ рж╕ржм ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржжрзЗржЦрж╛ржУ
               if (query === "") {
               performSearch(""); // performSearch ржлрж╛ржВрж╢ржи ржЦрж╛рж▓рж┐ рж╕рзНржЯрзНрж░рж┐ржВ ржкрзЗрж▓рзЗ рж╕ржм ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржжрзЗржЦрж╛ржирзЛрж░ ржЬржирзНржп ржбрж┐ржЬрж╛ржЗржи ржХрж░рж╛ ржЖржЫрзЗ
               }
});    

            // рж╕рж╛рж░рзНржЪ ржмрж╛ржЯржирзЗ ржХрзНрж▓рж┐ржХ ржЗржнрзЗржирзНржЯ
            searchButton.addEventListener('click', () => {
                performSearch(searchInput.value);
                suggestionsBox.innerHTML = ''; // рж╕рж╛ржЬрзЗрж╢ржи ржмржирзНржз
            });

            // ржпржЦржи ржЗржиржкрзБржЯ ржПрж░ ржмрж╛ржЗрж░рзЗ ржХрзНрж▓рж┐ржХ ржХрж░рж╛ рж╣ржмрзЗ, рждржЦржи рж╕рж╛ржЬрзЗрж╢ржи ржмржХрзНрж╕ ржмржирзНржз ржХрж░рж╛
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-bar-section')) {
                    suggestionsBox.innerHTML = '';
                }
            });

            // --- ржЗржЙржЯрж┐рж▓рж┐ржЯрж┐ ржлрж╛ржВрж╢ржи ---

            // ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐рждрзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзЗ рж╕рзНржХрзНрж░рж▓ ржХрж░рж╛
            document.getElementById('categoryRow').addEventListener('click', (e) => {
                const catEl = e.target.closest('.cat');
                if (catEl && catEl.dataset.catId) {
                    // рж╕рзНржХрзНрж░рж▓ ржХрж░рж╛рж░ ржЬржирзНржп рж╕ржм ржкрзНрж░рзЛржбрж╛ржХрзНржЯ рж░рзЗржирзНржбрж╛рж░ ржХрж░рждрзЗ рж╣ржмрзЗ
                    searchInput.value = "";
                    renderProducts(allProducts);
                    setTimeout(() => { // ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛рж░ ржЬржирзНржп setTimeout
                        const targetBlock = document.getElementById(catEl.dataset.catId + '-block');
                        if (targetBlock) {
                            targetBlock.scrollIntoView({behavior:'smooth',block:'start'});
                        }
                    }, 50);
                }
            });

            // ржорзВрж▓рзНржп ржХрзНржпрж╛рж▓ржХрзБрж▓рзЗрж╢ржирзЗрж░ ржлрж╛ржВрж╢ржи
            function calculatePrice(pricePerUnit, variant) {
                const variantText = variant.toLowerCase().trim();
                let quantityInKg = 0;

                if (variantText.endsWith('kg')) {
                    quantityInKg = parseFloat(variantText.replace('kg', ''));
                } else if (variantText.endsWith('g')) {
                    quantityInKg = parseFloat(variantText.replace('g', '')) / 1000;
                } else if (variantText.endsWith('litre')) {
                       quantityInKg = parseFloat(variantText.replace('litre', '')); // рж▓рж┐ржЯрж╛рж░ржХрзЗ kg ржПрж░ рж╕ржорждрзБрж▓рзНржп ржзрж░рж╛
                }
                // "ржкрзНрж░рждрж┐ ржкрж┐рж╕/ржЖржЯрж┐" ржЗрждрзНржпрж╛ржжрж┐рж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржпржжрж┐ рж╕рж░рж╛рж╕рж░рж┐ ржжрж╛ржо рж╣ржпрж╝, рждржмрзЗ рзз ржзрж░рж╛
                else {
                    quantityInKg = 1;
                }

                return pricePerUnit * quantityInKg;
            }

            // ржХрж╛рж░рзНржЯ ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
            function updateCart() {
                const totalItems = cart.length;
                const totalAmount = cart.reduce((sum, item) => sum + item.totalPrice, 0);

                cartCount.textContent = totalItems;
                sidebarCartCount.textContent = totalItems;
                checkoutTotalAmount.textContent = totalAmount.toFixed(2);
                codTotalBill.textContent = totalAmount.toFixed(2);
                codTotalItems.textContent = totalItems;

                cartItemsList.innerHTML = '';
                if (cart.length === 0) {
                    cartItemsList.innerHTML = '<p class="empty-cart-msg">ржЖржкржирж╛рж░ ржмрзНржпрж╛ржЧ ржЦрж╛рж▓рж┐ред</p>';
                } else {
                    // ржХрж╛рж░рзНржЯ ржЖржЗржЯрзЗржо рж░рзЗржирзНржбрж╛рж░
                    cart.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'cart-item';
                        itemDiv.innerHTML = `
                            <div class="cart-item-details">
                                <img src="${item.image}" alt="${item.name}" style="width:40px; height:40px; object-fit:cover; border-radius:5px;">
                                <div>
                                    <p style="font-weight:600; font-size:14px;">${item.name}</p>
                                    <p class="muted" style="font-size:12px;">${item.variant}</p>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <p style="color:var(--accent-2); font-weight:700;">RM ${item.totalPrice.toFixed(2)}</p>
                                <button class="remove-cart-item-btn" data-index="${index}">&times;</button>
                            </div>
                        `;
                        cartItemsList.appendChild(itemDiv);
                    });
                }

                // рж░рж┐ржорзБржн ржмрж╛ржЯржи рж▓рж┐рж╕рзЗржирж╛рж░
                document.querySelectorAll('.remove-cart-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.currentTarget.dataset.index);
                        cart.splice(indexToRemove, 1);
                        updateCart();
                    });
                });
            }

            // --- рж▓ржЧржЗржи/рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ ржоржбрж╛рж▓ рж▓ржЬрж┐ржХ ---
            loginBtn.addEventListener('click', () => {
                loginModal.style.display = 'block';
            });

            closeModals.forEach(btn => {
                btn.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                    codModal.style.display = 'none';
                });
            });

            window.onclick = (event) => {
                if (event.target == loginModal) {loginModal.style.display = 'none';}
                if (event.target == codModal) {codModal.style.display = 'none';}
            };

            switchToRegister.addEventListener('click', () => {
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
                modalTitle.textContent = 'ржПржХрж╛ржЙржирзНржЯ рждрзИрж░рзА ржХрж░рзБржи';
            });

            switchToLogin.addEventListener('click', () => {
                registerForm.classList.remove('active');
                loginForm.classList.add('active');
                modalTitle.textContent = 'рж▓ржЧржЗржи';
            });

            // рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи рж▓ржЬрж┐ржХ
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('regEmail').value;
                const name = document.getElementById('regName').value;
                const number = document.getElementById('regNumber').value;
                const address = document.getElementById('regAddress').value;
                const password = document.getElementById('regPassword').value;

                try {
                    await window.saveUser({ email, name, number, address, password }, password); // password field рж╕рзЗржн рж╣ржЪрзНржЫрзЗ
                    alert('рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи рж╕ржлрж▓! ржЖржкржирж┐ ржПржЦржи рж▓ржЧржЗржи ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред');
                    switchToLogin.click();
                } catch (error) {
                    alert('рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢ржи ржмрзНржпрж░рзНрже: ' + error.message);
                }
            });

            // рж▓ржЧржЗржи рж▓ржЬрж┐ржХ
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const result = await window.loginUser(email, password);
                    if (result.success) {
                        loggedInUser = result.user;
                        loginModal.style.display = 'none';
                        // рж╣рзЗржбрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржХрж╛рж░ржгрзЗ ржПржЗ рж▓рж╛ржЗржиржЯрж┐ ржирждрзБржи ржХрзЛржб ржжрж┐ржпрж╝рзЗ ржкрзНрж░рждрж┐рж╕рзНржерж╛ржкржи ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
                        const loginBtnText = document.getElementById('loginBtnText');
                        if (loginBtnText) {
                            loginBtnText.textContent = loggedInUser.name.split(' ')[0] || 'ржПржХрж╛ржЙржирзНржЯ';
                        }

                        alert('рж▓ржЧржЗржи рж╕ржлрж▓!');
                    } else {
                         alert('ржЗржорзЗржЗрж▓ ржмрж╛ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржнрзБрж▓ред');
                    }
                } catch (error) {
                    alert('рж▓ржЧржЗржи ржмрзНржпрж░рзНрже: ' + error.message);
                }
            });

            // --- ржнрзЗрж░рж┐ржпрж╝рзЗржирзНржЯ ржмржЯржо рж╢рзАржЯ рж▓ржЬрж┐ржХ ---

            productsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.add-to-cart-trigger');
                if (btn) {
                    const variants = btn.dataset.variants.split(',');
                    const price = parseFloat(btn.dataset.price);
                    const name = btn.dataset.name;
                    const image = btn.dataset.image;
                    const productId = btn.dataset.id;

                    currentProduct = { id: productId, name, image, price, variants };
                    selectedVariant = null;

                    document.getElementById('sheetProductImage').src = image;
                    document.getElementById('sheetProductName').textContent = name;
                    document.getElementById('sheetProductPricePerUnit').textContent = `RM ${price.toFixed(2)}/ржкрзНрж░рждрж┐ ржХрзЗржЬрж┐`;

                    variantChoices.innerHTML = '';
                    variants.forEach(variant => {
                        const cleanVariant = variant.trim();
                        const btn = document.createElement('button');
                        btn.className = 'variant-btn';
                        btn.textContent = cleanVariant;
                        btn.dataset.variant = cleanVariant;
                        variantChoices.appendChild(btn);
                    });

                    totalPriceDisplay.textContent = '0.00';
                    variantSheet.classList.add('active');
                }
            });

            closeSheetBtn.addEventListener('click', () => {
                variantSheet.classList.remove('active');
            });

            variantChoices.addEventListener('click', (e) => {
                const btn = e.target.closest('.variant-btn');
                if (btn) {
                    document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedVariant = btn.dataset.variant;

                    const totalPrice = calculatePrice(currentProduct.price, selectedVariant);
                    totalPriceDisplay.textContent = totalPrice.toFixed(2);
                }
            });

            // ржХрж┐ржирзБржи (Add to Cart) рж▓ржЬрж┐ржХ
            addToCartConfirmBtn.addEventListener('click', (e) => {
                if (!selectedVariant) {
                    alert('ржжржпрж╝рж╛ ржХрж░рзЗ ржПржХржЯрж┐ ржнрзЗрж░рж┐ржпрж╝рзЗржирзНржЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред');
                    return;
                }

                const totalPrice = parseFloat(totalPriceDisplay.textContent);
                const newItem = {
                    id: currentProduct.id,
                    name: currentProduct.name,
                    image: currentProduct.image,
                    pricePerUnit: currentProduct.price,
                    variant: selectedVariant,
                    totalPrice: totalPrice
                };

                cart.push(newItem);
                updateCart();
                variantSheet.classList.remove('active');

                // --- Fly to Cart Animation ---
                const cartRect = document.querySelector('#cartBtn').getBoundingClientRect(); // ржирждрзБржи рж╣рзЗржбрж╛рж░рзЗрж░ ID ржмрзНржпржмрж╣рж╛рж░
                const sheetRect = variantSheet.getBoundingClientRect();

                const flyingImg = document.createElement('img');
                flyingImg.src = currentProduct.image;
                flyingImg.className = 'flying-product';

                // рж╕рзНржЯрж╛рж░рзНржЯрж┐ржВ ржкржЬрж┐рж╢ржи: ржмржЯржо рж╢рзАржЯрзЗрж░ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржЗржорзЗржЬ ржерзЗржХрзЗ
                flyingImg.style.left = `${sheetRect.left + 28}px`;
                flyingImg.style.top = `${sheetRect.top + 30}px`;

                // ржбрзЗрж╕рзНржЯрж┐ржирзЗрж╢ржи ржкржЬрж┐рж╢ржи: ржХрж╛рж░рзНржЯ ржЖржЗржХржирзЗ (CSS variable ржжрж┐ржпрж╝рзЗ рж╕рзЗржЯ ржХрж░рж╛)
                document.documentElement.style.setProperty('--dx', `${cartRect.left - (sheetRect.left + 28)}px`);
                document.documentElement.style.setProperty('--dy', `${cartRect.top - (sheetRect.top + 30)}px`);

                document.body.appendChild(flyingImg);

                setTimeout(() => {
                    flyingImg.remove();
                    if(cart.length === 1) {
                        cartSidebar.classList.add('open'); // ржкрзНрж░ржержо ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржпрзЛржЧ ржХрж░рж▓рзЗ рж╕рж╛ржЗржбржмрж╛рж░ ржЕржЯрзЛ ржУржкрзЗржи
                    }
                }, 800);
            });

            // --- ржХрзБржЗржХ ржЪрзЗржХржЖржЙржЯ рж╕рж╛ржЗржбржмрж╛рж░ рж▓ржЬрж┐ржХ ---

            cartBtn.addEventListener('click', () => {
                cartSidebar.classList.toggle('open');
            });

            closeSidebarBtn.addEventListener('click', () => {
                cartSidebar.classList.remove('open');
            });

            // ржХрзНржпрж╛рж╢ ржЕржи ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржмрж╛ржЯржи ржХрзНрж▓рж┐ржХ
            cashOnDeliveryBtn.addEventListener('click', () => {
                if (cart.length === 0) {
                    alert('ржЖржкржирж╛рж░ ржмрзНржпрж╛ржЧрзЗ ржХрзЛржирзЛ ржкрзНрж░ржбрж╛ржХрзНржЯ ржирзЗржЗред');
                    return;
                }

                // рж▓ржЧржЗржи ржХрж░рж╛ ржерж╛ржХрж▓рзЗ рждржерзНржп ржкрзНрж░рж┐-ржлрж┐рж▓ ржХрж░рж╛
                if (loggedInUser) {
                    document.getElementById('codName').value = loggedInUser.name || '';
                    document.getElementById('codNumber').value = loggedInUser.number || '';
                    document.getElementById('codAddress').value = loggedInUser.address || '';
                } else {
                    // рж▓ржЧржЗржи ржирж╛ ржерж╛ржХрж▓рзЗ, ржлрж░рзНржо ржЦрж╛рж▓рж┐ ржХрж░рж╛
                    document.getElementById('codName').value = '';
                    document.getElementById('codNumber').value = '';
                    document.getElementById('codAddress').value = '';
                }

                codModal.style.display = 'block';
            });

            // ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо ржХрж░рзБржи (COD) рж▓ржЬрж┐ржХ
            codForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('codName').value;
                const number = document.getElementById('codNumber').value;
                const address = document.getElementById('codAddress').value;

                // item рж╕рзНржЯрзНрж░рж┐ржВ рждрзИрж░рж┐ ржХрж░рж╛: "ржЖрж▓рзБ-1kg-RM 2-pending,ржЯржорзЗржЯрзЛ-500g-RM 1-pending"
                const itemString = cart.map(item =>
                    `${item.name}-${item.variant}-RM ${item.totalPrice.toFixed(2)}-pending`
                ).join(',');

                const orderData = {
                    name: name,
                    number: number,
                    address: address,
                    item: itemString,
                    status: 'pending'
                };

                try {
                    await window.saveOrder(orderData); // Firebase-ржП рж╕рзЗржн ржХрж░рж╛
                    alert('ржЕрж░рзНржбрж╛рж░ рж╕ржлрж▓ржнрж╛ржмрзЗ ржХржиржлрж╛рж░рзНржо рж╣ржпрж╝рзЗржЫрзЗ! ржЦрзБржм рж╢рзАржШрзНрж░ржЗ ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рж╛ рж╣ржмрзЗред');

                    // рж░рж┐рж╕рзЗржЯ ржХрж░рж╛
                    codModal.style.display = 'none';
                    cart = [];
                    updateCart();
                    cartSidebar.classList.remove('open');
                } catch (error) {
                    alert('ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ: ' + error.message);
                }
            });

            // --- ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬрзЗрж╢ржи ---
            loadData();
            updateCart(); // ржХрж╛рж░рзНржЯ ржЗржирж┐рж╢рж┐ржпрж╝рж╛рж▓рж╛ржЗржЬ ржХрж░рж╛

            // рж╕рзНрж▓рж╛ржЗржбрж╛рж░ рж▓ржЬрж┐ржХ (ржЖржкржирж╛рж░ ржжрзЗржУржпрж╝рж╛ ржХрзЛржб)
            let slideIndex=0; const slidesEl = document.getElementById('slides');
            window.showSlide = (i) => {
              const total = slidesEl.children.length; slideIndex = (i + total) % total;
              slidesEl.style.transform = `translateX(-${slideIndex*100}%)`;
            }
            window.nextSlide = () => { showSlide(slideIndex+1); }
            window.prevSlide = () => { showSlide(slideIndex-1); }
            setInterval(window.nextSlide,5000);
            window.scrollToProducts = () => { document.getElementById('productsContainer').scrollIntoView({behavior:'smooth'}) }
        });
    </script>
</body>
</html>